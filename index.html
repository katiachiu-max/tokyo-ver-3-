<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥æœ¬ç”Ÿæ—¥ä¹‹æ—…</title>
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#EFE9E1">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2060/2060250.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Confetti JS -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        /* Fonts Import */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Noto+Sans+TC:wght@300;400;500;700&family=Outfit:wght@300;400;500;600;700&family=Bodoni+Moda:ital,opsz,wght@0,6..96,400..900;1,6..96,400..900&family=Zen+Old+Mincho:wght@400;500;600;700;900&display=swap');

        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #D8D8D8; 
            -webkit-tap-highlight-color: transparent;
        }

        /* Fonts */
        .font-serif-en { font-family: 'Zen Old Mincho', serif !important; letter-spacing: 0.02em; }
        .font-sans-en { font-family: 'Outfit', sans-serif !important; letter-spacing: 0.05em; }
        .font-serif-jp { font-family: 'Zen Old Mincho', serif !important; font-weight: 600; letter-spacing: 0.05em; }
        .font-sans-jp { font-family: 'Noto Sans TC', sans-serif !important; font-weight: 400; }
        .font-cover-en { font-family: 'Bodoni Moda', serif !important; letter-spacing: 0.02em; }
        .font-cover-jp { font-family: 'Zen Old Mincho', serif !important; }

        /* Utilities */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* App Container */
        .app-container {
            border-radius: 0px;
            box-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            position: relative; 
            min-height: 100vh;
            background-color: #EFE9E1;
        }
        @media (min-width: 768px) {
            .app-container { border-radius: 2rem; }
        }

        /* Animations */
        #home-screen {
            transition: opacity 0.6s ease-in-out, visibility 0.6s;
            opacity: 1;
            z-index: 100;
        }

        #app-content-layer {
            transition: transform 0.8s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.6s ease;
            transform: scale(0.95);
            opacity: 0;
            will-change: transform, opacity;
        }
        #app-content-layer.entered {
            transform: scale(1);
            opacity: 1;
        }

        /* Scroll Reveal Animation */
        .reveal-item {
            opacity: 0;
            transform: translateY(50px);
            transition: opacity 1.0s ease-out, transform 1.0s cubic-bezier(0.2, 0.8, 0.2, 1);
            will-change: opacity, transform;
        }
        .reveal-item.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Zoom In Animation */
        @keyframes zoom-in-enter {
            0% { transform: scale(0.96) translateY(10px); opacity: 0; }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }
        .animate-zoom-in {
            animation: zoom-in-enter 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        /* Collapsible Sections */
        #booking-details-content {
            transition: max-height 0.6s cubic-bezier(0.65, 0, 0.35, 1);
            max-height: 0;
            overflow: hidden;
        }
        #booking-details-content.open {
            max-height: 1000px;
        }
        
        /* Wallet Form Toggle */
        #wallet-form-container {
            transition: max-height 0.4s ease-in-out, opacity 0.4s ease;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        #wallet-form-container.open {
            max-height: 600px;
            opacity: 1;
        }

        .item-details {
            transition: max-height 0.5s cubic-bezier(0.65, 0, 0.35, 1), opacity 0.4s ease;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        .itinerary-item.active .item-details {
            max-height: 600px;
            opacity: 1;
            margin-top: 1.5rem;
        }
        .itinerary-item.active .chevron {
            transform: rotate(180deg);
        }

        /* SOS Button */
        .sos-fab {
            position: fixed;
            bottom: 30px;
            right: 20px;
            z-index: 60;
            box-shadow: 0 10px 25px rgba(185, 28, 28, 0.3);
            transition: transform 0.2s, opacity 0.5s;
        }
        .sos-fab:active { transform: scale(0.92); }
        .sos-fab.hidden-ui { opacity: 0; pointer-events: none; }

        /* Next Event Floating Bar */
        #next-event-bar {
            position: fixed;
            bottom: 30px;
            left: 20px;
            right: 90px;
            z-index: 50;
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.4s ease;
            transform: translateY(0);
            opacity: 1;
            display: flex;
        }
        #next-event-bar.scroll-hidden {
            transform: translateY(150%);
            opacity: 0;
        }
        #next-event-bar.force-hidden {
            display: none !important;
        }
        #next-event-bar.hidden-ui {
            opacity: 0; pointer-events: none;
        }

        /* Timeline Styling */
        .itinerary-item {
            position: relative;
            transition: background-color 0.3s ease;
        }
        .itinerary-item:active {
            background-color: rgba(0,0,0,0.02);
        }
        
        .timeline-line {
            position: absolute;
            left: 1.65rem;
            top: 3.5rem;
            bottom: -1rem;
            width: 1px;
            background-color: #D6D3D1; 
            z-index: 0;
        }
        .itinerary-item:last-child .timeline-line {
            display: none;
        }

        /* Weather Card Glass Effect */
        .weather-glass {
            background: linear-gradient(135deg, #2C3E50, #000000);
            color: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }
        .weather-glass::before {
            content: '';
            position: absolute;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
            pointer-events: none;
        }

        /* Wallet Styling */
        .input-premium {
            background: #F7F5F2;
            border: 1px solid #E5E0D8;
            border-radius: 8px;
            padding: 12px;
            font-family: 'Outfit', sans-serif;
            transition: all 0.3s ease;
        }
        .input-premium:focus {
            background: white;
            border-color: #57534E;
            outline: none;
        }
        
        /* Icon Animations */
        @keyframes smooth-takeoff {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            20% { transform: translate(-10px, 5px) scale(0.9); }
            40% { transform: translate(10px, -10px) rotate(-10deg) scale(1.1); opacity: 1; }
            100% { transform: translate(200px, -120px) rotate(-20deg) scale(0.5); opacity: 0; }
        }
        .animate-plane {
            animation: smooth-takeoff 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            display: inline-block;
            transform-origin: center center;
            will-change: transform, opacity;
        }

        @keyframes bounce-custom {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.3); }
        }
        .animate-bounce-custom {
            animation: bounce-custom 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: inline-block;
        }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen md:py-10 bg-gray-300">

    <!-- Mobile-First Container -->
    <div class="w-full max-w-md app-container bg-[#EFE9E1] md:shadow-2xl">
        
        <!-- ============================================= -->
        <!-- HOME SCREEN (Cover) -->
        <!-- ============================================= -->
        <div id="home-screen" 
             onclick="enterApp()" 
             class="fixed inset-0 flex flex-col justify-end p-10 cursor-pointer bg-cover bg-center"
             style="background-image: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.3) 50%, rgba(0,0,0,0.1) 100%), url('https://images.unsplash.com/photo-1513407030348-c983a97b98d8?q=80&w=2072&auto=format&fit=crop');">
            
            <div class="mb-16 text-center text-white">
                <div class="inline-flex items-center justify-center px-5 py-2 mb-6 border border-white/30 bg-white/10 backdrop-blur-md rounded-full">
                    <span class="text-[10px] tracking-[0.3em] uppercase font-bold font-cover-en text-white">ğŸ‡¯ğŸ‡µ TOKYO TRIP 2025 ğŸ—¼</span>
                </div>
                
                <h1 class="text-7xl font-bold mb-2 leading-none tracking-tight">
                    <span class="font-cover-en italic block mb-1">12</span>
                    <span style="font-family: 'Zen Old Mincho', serif;" class="text-4xl block mt-2">ç”Ÿæ—¥ä¹‹æ—…</span>
                </h1>
                
                <div class="w-12 h-0.5 bg-white/50 mx-auto my-6"></div>

                <p class="text-lg font-cover-en italic font-medium tracking-widest opacity-90">
                    Happy Birthday
                </p>
            </div>
            
            <div class="absolute bottom-10 left-0 right-0 text-center animate-pulse">
                <p class="text-[10px] font-sans-en font-bold tracking-[0.3em] uppercase text-white/60">
                    Tap to Enter
                </p>
            </div>
        </div>
        
        <!-- ============================================= -->
        <!-- MAIN APP CONTENT -->
        <!-- ============================================= -->
        <div id="app-content-layer" class="h-full flex flex-col relative">

            <!-- Sticky Header Area -->
            <header id="main-header" class="bg-[#EFE9E1] sticky top-0 z-40 shadow-sm">
                <div class="px-8 pt-10 pb-4">
                    <div class="flex justify-between items-end border-b border-stone-300 pb-4">
                        <div>
                            <h1 id="header-title" class="text-3xl font-bold text-stone-800 tracking-wide font-serif-jp">æ±äº¬è¡Œ</h1>
                            <p class="text-xs text-stone-500 font-bold mt-2 font-sans-en tracking-widest">DEC 02 â€” DEC 05</p>
                        </div>
                        <div id="budget-summary" class="text-right">
                            <!-- Budget injected by JS -->
                        </div>
                    </div>
                    
                    <!-- Booking Toggle -->
                    <button onclick="toggleBookingDetails()" class="w-full py-3 flex justify-between items-center group">
                        <span class="text-[10px] font-bold text-stone-400 tracking-[0.2em] uppercase font-sans-en group-hover:text-stone-600 transition-colors">
                            TICKETS & HOTEL
                        </span>
                        <span id="toggle-icon" class="text-stone-400 transform transition-transform duration-300">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </span>
                    </button>
                </div>

                <!-- Booking Details (Collapsible) -->
                <div id="booking-details-content" class="bg-[#E8E2D9]">
                    <div id="booking-details-inner" class="px-8 py-6 space-y-6">
                        <!-- Content injected by JS -->
                    </div>
                </div>

                <!-- Day Tabs (Always Visible) -->
                <nav id="day-tabs" class="flex justify-around px-2 border-b border-stone-200 bg-[#EFE9E1]">
                    <!-- Tabs injected by JS -->
                </nav>
            </header>

            <!-- Main Scroll Area -->
            <main id="itinerary-content" class="flex-1 overflow-y-auto p-0 pb-32 bg-[#EFE9E1]">
                <!-- Timeline injected by JS -->
            </main>
        
        </div>
        
        <!-- Floating Elements moved OUTSIDE of content layer for safer positioning -->
        
        <!-- Next Event Floating Card (Smart Hide/Show + Animation) -->
        <div id="next-event-bar" class="glass-dark rounded-xl p-4 flex items-center justify-between cursor-pointer group hidden-ui bg-[#2C2C2C]/95 backdrop-blur-md border border-stone-600/30 shadow-2xl">
            <div class="flex flex-col">
                <span class="text-[9px] text-stone-300 font-sans-en tracking-[0.2em] uppercase mb-1">NEXT STOP</span>
                <h3 id="next-event-title" class="text-sm font-bold font-serif-jp text-white truncate max-w-[160px]">Loading...</h3>
            </div>
            <div class="flex items-center pl-4 border-l border-white/10 ml-3">
                    <span id="next-event-icon" class="text-lg mr-2">ğŸ“</span>
                    <span id="next-event-time" class="text-lg font-serif-en text-white italic">--:--</span>
            </div>
        </div>

        <!-- SOS Button -->
        <button onclick="switchToEmergency()" class="sos-fab bg-red-700 hover:bg-red-800 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg active:shadow-none transition-colors hidden-ui">
            <span class="text-xl font-bold font-sans-en">SOS</span>
        </button>

    </div>

    <!-- ============================================= -->
    <!-- JAVASCRIPT -->
    <!-- ============================================= -->
    <script>
        // --- GLOBAL HELPER FUNCTIONS (Must be defined first) ---
        
        // 1. Remove item from Wallet (Expense Tracker)
        window.removeWalletItem = function(id) {
            // Use standard JS confirm
            if (confirm("æ‚¨ç¢ºå®šè¦åˆªé™¤é€™ç­†æ¶ˆè²»ç´€éŒ„å—ï¼Ÿ")) {
                const data = JSON.parse(localStorage.getItem('japanTripWallet')) || [];
                const newData = data.filter(item => item.id !== id);
                localStorage.setItem('japanTripWallet', JSON.stringify(newData));
                
                // Re-render if currently on wallet page
                // Access renderWalletList via global scope logic since it's defined below
                const btn = document.getElementById('tab-wallet');
                if (btn && btn.classList.contains('text-stone-800')) { // simple check if active
                     renderWalletList_Global();
                }
            }
        };

        // 2. Hide item from Itinerary (Timeline)
        window.hideItineraryItem = function(dayIdx, eventIdx) {
            if (confirm("ç¢ºå®šè¦éš±è—æ­¤è¡Œç¨‹å—ï¼Ÿ\n(è²»ç”¨å°‡æœƒå¾é ç®—ä¸­æ‰£é™¤)")) {
                const hidden = JSON.parse(localStorage.getItem('japanTripHiddenEvents')) || {};
                const key = `${dayIdx}-${eventIdx}`;
                hidden[key] = true;
                localStorage.setItem('japanTripHiddenEvents', JSON.stringify(hidden));
                
                // Refresh current view
                switchDay_Global(dayIdx);
                updateBudget_Global();
            }
        };

        // PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js').catch(err => console.log(err)));
        }

        // Data
        const BOOKING_INFO = {
            orderId: "1359041237819550",
            pnr: "E58BJS",
            passengers: ["CHIU HIU WING", "LAM CHIU TING"],
            baggage: { checked: "Checked: 1 pc (20kg)", carryOn: "Carry-on: 1 pc", checkInTime: "Arrive 3hrs prior" },
            hotel: { name: "Super Hotel Premier Akihabara", address: "2 Chome-25-8 Kanda Sudacho", phone: "+81-3-6890-9000", checkInLimit: "23:30", payment: "HK$46.00 + Tax" }
        };

        const EMERGENCY_INFO = [
            { title: "Police", number: "110", desc: "Theft, Accidents", icon: "ğŸ‘®" },
            { title: "Ambulance / Fire", number: "119", desc: "Medical Emergency, Fire", icon: "ğŸš‘" },
            { title: "HK Immigration", number: "+852 1868", desc: "24h Assistance Hotline", icon: "ğŸ‡­ğŸ‡°" },
            { title: "Hotel Front Desk", number: BOOKING_INFO.hotel.phone, desc: "Super Hotel Akihabara", icon: "ğŸ¨" }
        ];

        const itineraryData = [
            {
                date: "12/2 (äºŒ)", shortDate: "02", city: "OTSUKA / GINZA", theme: "æ’éšŠç¾é£Ÿèˆ‡éŠ€åº§", 
                weather: { temp: "Loading...", condition: "...", summary: "Fetching..." },
                lat: 35.7311, lng: 139.7281, isoDate: "2025-12-02",
                guide: "Bongo é£¯ç³°å»ºè­° 10:30 å°±å»æ’éšŠã€‚éŠ€åº§æœ¨æ‘å®¶ç´…è±†éºµåŒ…å¿…è²·ã€‚",
                events: [
                    { time: "06:55", activity: "æŠµé”æˆç”° T2", icon: "ğŸ›¬", category: 'transport', cost: 0, desc: "UO854 | é ˜è¡Œæã€å…¥å¢ƒ", address: "Narita Airport Terminal 2" },
                    { time: "08:30", activity: "å‰å¾€é…’åº—å¯„æ”¾è¡Œæ", icon: "ğŸ§³", category: 'transport', cost: 2500, desc: "Skyliner (æ—¥æš®é‡Œè½‰JR) -> ç§‹è‘‰åŸ", address: BOOKING_INFO.hotel.address },
                    // æ›´æ–°è¡Œç¨‹ï¼šå»å¤§å¡š
                    { time: "10:15", activity: "å‰å¾€å¤§å¡šç«™", icon: "ğŸš‡", category: 'transport', cost: 200, desc: "å±±æ‰‹ç·šç›´é” (ç´„15åˆ†)", address: "Otsuka Station" },
                    { time: "10:30", activity: "æ’éšŠï¼šOnigiri Bongo", icon: "ğŸ™", category: 'food', cost: 0, desc: "æ±äº¬æœ€å¼·é£¯ç³°ï¼Œæº–å‚™æ’éšŠ (11:30é–‹é–€)<br>ğŸ”¥ å¿…åƒ: ç­‹å­ã€é®­é­šç¾ä¹ƒæ»‹ã€åµé»ƒè‚‰é¬†", address: "Onigiri Bongo" },
                    { time: "11:30", activity: "åˆé¤ï¼šBongo é£¯ç³°", icon: "ğŸ˜‹", category: 'food', cost: 0, desc: "æ¨è–¦ï¼šç­‹å­ã€é®­é­šç¾ä¹ƒæ»‹ã€è›‹é»ƒè‚‰é¬†", address: "" },
                    { time: "13:30", activity: "å‰å¾€éŠ€åº§", icon: "ğŸ›ï¸", category: 'transport', cost: 200, desc: "å±±æ‰‹ç·š/åœ°éµ", address: "Ginza Station" },
                    { time: "14:00", activity: "éŠ€åº§é€›è¡— / ä¸‹åˆèŒ¶", icon: "âœ¨", category: 'attraction', cost: 0, desc: "Uniqlo æ——è‰¦åº— / ä¼Šæ±å±‹ / æœ¨æ‘å®¶", address: "UNIQLO Ginza" },
                    { time: "19:30", activity: "æ™šé¤ï¼šUshigoro éŠ€åº§åº—", icon: "ğŸ¥©", category: 'food', cost: 31600, desc: "é ç´„è™Ÿ: AWYTFWX9VE | å­£ç¯€åŒ å¥—é¤<br>ğŸ”¥ å¿…åƒ: ç©¶æ¥µåšåˆ‡é»‘æ¯›å’Œç‰›ç‰›èˆŒã€ç”Ÿæ‹Œç‰›è‚‰ã€æ¾éœ²å£½å–œç‡’", address: "Yakiniku Ushigoro Ginza Ten" },
                    { time: "21:30", activity: "è¾¦ç†å…¥ä½ Check-in", icon: "ğŸ¨", category: 'hotel', cost: 0, desc: "âš ï¸ 23:30 å‰å¿…é ˆå®Œæˆï¼", address: BOOKING_INFO.hotel.address, isWarning: true }
                ]
            },
            {
                date: "12/3 (ä¸‰)", shortDate: "03", city: "HARAJUKU / ROPPONGI", theme: "æ™‚å°šèˆ‡ç‡ˆé£¾", 
                weather: { temp: "Loading...", condition: "...", summary: "Fetching..." },
                lat: 35.6664, lng: 139.7316, isoDate: "2025-12-03",
                guide: "I'm donut? å»ºè­°é–‹åº—å‰æ’éšŠã€‚å…­æœ¬æœ¨ç‡ˆé£¾èƒŒæ™¯æ˜¯æ±äº¬éµå¡”ã€‚",
                events: [
                    { time: "09:30", activity: "è‡ªç”±æ´»å‹•", icon: "âœ¨", category: 'attraction', cost: 0, desc: "æ˜æ²»ç¥å®® / åŸå®¿éš¨æ„é€›é€›", address: "" },
                    { time: "11:30", activity: "åˆé¤ï¼šæ¥µå‘³å±‹", icon: "ğŸ¥©", category: 'food', cost: 0, desc: "æ¾€è°· Parco åº— | éµæ¿æ¼¢å ¡æ’ (å»ºè­°é–‹åº—å‰æ’éšŠ)<br>ğŸ”¥ å¿…åƒ: æ¥µå‘³å±‹æ¼¢å ¡æ’ã€ä¼Šè¬é‡Œç‰›ç‰›æ’", address: "Kiwamiya Shibuya Parco" },
                    { time: "13:30", activity: "I'm donut? åŸå®¿åº—", icon: "ğŸ©", category: 'food', cost: 0, desc: "è¶…äººæ°£ç”Ÿç”œç”œåœˆ (åŸå®¿ç«™å°é¢)<br>ğŸ”¥ å¿…åƒ: åŸå‘³ç”Ÿç”œç”œåœˆã€é–‹å¿ƒæœã€ç”Ÿç«è…¿", address: "I'm donut? Harajuku" },
                    { time: "14:30", activity: "mofusand åŸå®¿åº—", icon: "ğŸ±", category: 'attraction', cost: 0, desc: "mofusand ã‚‚ãµã‚‚ãµã‚¹ãƒˆã‚¢ (åŸå®¿åº—) | é¯Šé­šè²“å‘¨é‚Šè²·çˆ†ï¼", address: "3-23-6 Jingumae, Shibuya City" },
                    // è£œå› ANAKUMA CAFE
                    { time: "15:15", activity: "ANAKUMA CAFE", icon: "ğŸ§¸", category: 'food', cost: 1500, desc: "åŸå®¿åº— | è¶…ç™‚ç™’ç†Šç†Šæ´ï¼Œç†ŠæŒéé£²æ–™çµ¦ä½ ï¼", address: "ANAKUMA CAFE Harajuku" },
                    { time: "16:00", activity: "å‰å¾€å…­æœ¬æœ¨", icon: "ğŸš‡", category: 'transport', cost: 200, desc: "æ­ä¹˜åœ°éµå‰å¾€å…­æœ¬æœ¨", address: "Roppongi Station" },
                    { time: "17:30", activity: "æ™šé¤ï¼šSushi Tokyo Ten", icon: "ğŸ£", category: 'food', cost: 0, desc: "å…­æœ¬æœ¨åº— | Omakase (éœ€æº–æ™‚)<br>ğŸ”¥ å¿…åƒ: æµ·è†½ã€é®‘é­šã€èœ†æ¹¯", address: "Sushi Tokyo Ten Roppongi" },
                    { time: "19:30", activity: "å…­æœ¬æœ¨è–èª•ç‡ˆé£¾", icon: "ğŸ„", category: 'attraction', cost: 0, desc: "Midtown -> æ«¸å‚é€šçµ•æ™¯", address: "Roppongi Keyakizaka Dori" }
                ]
            },
            {
                date: "12/4 (å››)", shortDate: "04", city: "FREE DAY", theme: "æ”¾é¬†ä¸€æ—¥", 
                weather: { temp: "Loading...", condition: "...", summary: "Fetching..." },
                lat: 35.6895, lng: 139.6917, isoDate: "2025-12-04",
                guide: "å»ºè­°å»æ–°å®¿å¾¡è‹‘æˆ–ä»£å®˜å±±æ•£æ­¥ã€‚",
                events: [ { time: "å…¨æ—¥", activity: "è‡ªç”±æ´»å‹•", icon: "âœ¨", category: 'attraction', cost: 0, desc: "ç¡åˆ°è‡ªç„¶é†’ï¼Œéš¨æ„æ¢ç´¢æ±äº¬", address: "" } ]
            },
            {
                date: "12/5 (äº”)", shortDate: "05", city: "TOKYO / NARITA", theme: "è‡ªç”±æ´»å‹•èˆ‡æ­¸ç¨‹", 
                weather: { temp: "Loading...", condition: "...", summary: "Fetching..." },
                lat: 35.7141, lng: 139.7774, isoDate: "2025-12-05",
                guide: "æŠŠæ¡æœ€å¾Œæ™‚é–“è£œè²¨æˆ–ä¼‘æ¯ã€‚Skyliner è¨˜å¾—å…ˆè²·ç¥¨ã€‚",
                events: [
                    { time: "09:30", activity: "é€€æˆ¿ Check-out", icon: "ğŸ‘‹", category: 'hotel', cost: 0, desc: "è¡Œæå¸¶è‡³ä¸Šé‡æˆ–å¯„æ”¾", address: BOOKING_INFO.hotel.address, isWarning: true },
                    // ä¿®æ”¹ï¼šå»æ©Ÿå ´å‰çš„è¡Œç¨‹æ”¹ç‚ºè‡ªç”±æ´»å‹•
                    { time: "10:00", activity: "è‡ªç”±æ´»å‹•", icon: "âœ¨", category: 'attraction', cost: 0, desc: "æœ€å¾Œè¡åˆºè£œè²¨ / æ‰¾é–“å’–å•¡å»³ä¼‘æ¯ / éš¨æ„æ¢ç´¢", address: "" },
                    { time: "15:30", activity: "Skyliner å¾€æ©Ÿå ´", icon: "ğŸš†", category: 'transport', cost: 2500, desc: "äº¬æˆä¸Šé‡ç«™ç™¼è»Š", address: "Keisei Ueno Station" },
                    { time: "16:45", activity: "æˆç”° T2 ç™»æ©Ÿ", icon: "ğŸ›«", category: 'transport', cost: 0, desc: "UO647 | èµ·é£›å‰3å°æ™‚", address: "Narita Airport Terminal 2" },
                    { time: "19:00", activity: "èµ·é£›è¿”æ¸¯", icon: "ğŸ‡­ğŸ‡°", category: 'transport', cost: 0, desc: "æ—…ç¨‹åœ“æ»¿çµæŸ", address: "" }
                ]
            }
        ];

        let currentActiveDay = 0;
        let isBookingOpen = false;
        let lastScrollTop = 0; 

        // --- Internal Logic ---
        
        // Assign to global for reference in window. functions
        window.renderWalletList_Global = renderWalletList;
        window.switchDay_Global = switchDay;
        window.updateBudget_Global = updateBudget;

        function getWalletData() {
            return JSON.parse(localStorage.getItem('japanTripWallet')) || [];
        }

        function saveWalletData(data) {
            localStorage.setItem('japanTripWallet', JSON.stringify(data));
            updateBudget();
        }

        function addExpense(item, amount, category, person) {
            const data = getWalletData();
            data.push({
                id: Date.now(),
                item,
                amount: parseFloat(amount),
                category,
                person, 
                date: new Date().toLocaleDateString()
            });
            saveWalletData(data);
            renderWalletList();
        }

        // --- Weather Logic ---
        async function fetchRealTimeWeather(dayIndex) {
            const day = itineraryData[dayIndex];
            if (!day.lat || !day.lng || !day.isoDate) return;

            const url = `https://api.open-meteo.com/v1/forecast?latitude=${day.lat}&longitude=${day.lng}&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=Asia%2FTokyo&start_date=${day.isoDate}&end_date=${day.isoDate}`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.daily && data.daily.time.length > 0) {
                    const maxTemp = Math.round(data.daily.temperature_2m_max[0]);
                    const wmoCode = data.daily.weather_code[0];

                    let condition = "Clear";
                    
                    if (wmoCode === 0) { condition = "Sunny"; }
                    else if (wmoCode >= 1 && wmoCode <= 3) { condition = "Cloudy"; }
                    else if (wmoCode >= 45 && wmoCode <= 48) { condition = "Foggy"; }
                    else if (wmoCode >= 51 && wmoCode <= 67) { condition = "Rainy"; }
                    else if (wmoCode >= 71) { condition = "Snowy"; }

                    day.weather.temp = `${maxTemp}Â°`;
                    day.weather.condition = condition;

                    if (currentActiveDay === dayIndex) {
                        const tempEl = document.getElementById('weather-temp-display');
                        const condEl = document.getElementById('weather-condition-display');
                        const iconEl = document.getElementById('weather-icon-display');
                        
                        if(tempEl) tempEl.innerText = day.weather.temp;
                        if(condEl) condEl.innerText = day.weather.condition;
                        if(iconEl) iconEl.innerHTML = getWeatherSvg(day.weather.condition);
                    }
                }
            } catch (error) {
                console.log("Weather fetch failed", error);
            }
        }

        function enterApp() {
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            setTimeout(() => {
                const home = document.getElementById('home-screen');
                const content = document.getElementById('app-content-layer');
                const nextBar = document.getElementById('next-event-bar');
                const sos = document.querySelector('.sos-fab');

                home.style.opacity = '0'; 
                home.style.pointerEvents = 'none';
                
                setTimeout(() => {
                    content.classList.add('entered');
                    nextBar.classList.remove('hidden-ui');
                    sos.classList.remove('hidden-ui');
                }, 50);

                setTimeout(() => { 
                    home.style.display = 'none'; 
                    updateStickyHeaderPosition(); 
                }, 800);
            }, 300);
        }

        function updateStickyHeaderPosition() {
            const headerHeight = document.getElementById('main-header').offsetHeight;
            const dayTabs = document.getElementById('day-tabs'); 
            if (dayTabs) {
                dayTabs.style.top = `${headerHeight}px`;
            }
        }

        function toggleBookingDetails() {
            isBookingOpen = !isBookingOpen;
            const content = document.getElementById('booking-details-content');
            const icon = document.getElementById('toggle-icon');
            
            if (isBookingOpen) {
                content.classList.add('open');
                icon.style.transform = 'rotate(180deg)';
            } else {
                content.classList.remove('open');
                icon.style.transform = 'rotate(0deg)';
            }
            setTimeout(updateStickyHeaderPosition, 600);
        }

        function updateBudget() {
            const budgetHKD = 12000;
            const exchangeRate = 0.052;
            
            const walletData = getWalletData();
            const totalExpensesJPY = walletData.reduce((sum, item) => sum + item.amount, 0);
            
            // Fixed expenses from itinerary (skipping hidden ones)
            let fixedExpensesJPY = 0;
            const hiddenEvents = JSON.parse(localStorage.getItem('japanTripHiddenEvents')) || {};
            itineraryData.forEach((d, dIdx) => d.events.forEach((e, eIdx) => {
                if (!hiddenEvents[`${dIdx}-${eIdx}`]) {
                    if (e.category === 'transport' || e.activity.includes('Ushigoro')) fixedExpensesJPY += e.cost;
                }
            }));

            const totalJPY = totalExpensesJPY + fixedExpensesJPY;
            const balance = budgetHKD - Math.round(totalJPY * exchangeRate);
            const balanceJPY = Math.round(balance / exchangeRate);

            document.getElementById('budget-summary').innerHTML = `
                <div class="flex flex-col items-end">
                    <span class="text-[8px] text-stone-400 font-bold tracking-widest font-sans-en mb-0.5">BALANCE</span>
                    <div class="flex flex-col items-end leading-tight">
                        <span class="text-base font-bold ${balance >= 0 ? 'text-stone-800' : 'text-red-700'} font-serif-en animate-balance">HK$${balance.toLocaleString()}</span>
                        <span class="text-[10px] font-medium ${balance >= 0 ? 'text-stone-400' : 'text-red-300'} font-serif-en">Â¥${balanceJPY.toLocaleString()}</span>
                    </div>
                </div>
            `;
            
            // Update Wallet Tab Summary
            const totalEl = document.getElementById('wallet-total');
            const dogEl = document.getElementById('wallet-dog');
            const pigEl = document.getElementById('wallet-pig');
            
            if(totalEl) {
                 const dogTotal = walletData.filter(x => x.person === 'é£Ÿå±ç‹—').reduce((sum, x) => sum + x.amount, 0);
                 const pigTotal = walletData.filter(x => x.person === 'éšè±¬ç‹').reduce((sum, x) => sum + x.amount, 0);
                 
                 totalEl.innerText = `Â¥${totalExpensesJPY.toLocaleString()}`;
                 dogEl.innerText = `Â¥${dogTotal.toLocaleString()}`;
                 pigEl.innerText = `Â¥${pigTotal.toLocaleString()}`;
            }
        }

        function renderBookingInfo() {
            const html = `
                <div class="flex flex-col space-y-4">
                    <div class="border-l-2 border-stone-400 pl-4">
                        <p class="text-[10px] text-stone-400 uppercase tracking-[0.2em] font-sans-en mb-1">Flight</p>
                        <div class="flex justify-between items-baseline">
                            <p class="text-lg font-bold font-serif-en text-stone-800">${BOOKING_INFO.pnr}</p>
                            <span class="text-stone-400">âœˆï¸</span>
                        </div>
                        <p class="text-xs text-stone-500 font-sans-en mt-1">${BOOKING_INFO.passengers.join(' & ')}</p>
                    </div>
                    
                    <div class="border-l-2 border-stone-300 pl-4">
                        <p class="text-[10px] text-stone-400 uppercase tracking-[0.2em] font-sans-en mb-1">Accommodation</p>
                        <div class="flex justify-between items-baseline">
                            <p class="text-base font-bold font-serif-jp text-stone-800 leading-snug w-3/4">${BOOKING_INFO.hotel.name}</p>
                            <span class="text-stone-400">ğŸ¨</span>
                        </div>
                        <p class="text-[10px] text-stone-500 font-sans-en mt-2 uppercase tracking-wide">${BOOKING_INFO.hotel.address}</p>
                    </div>
                </div>
            `;
            document.getElementById('booking-details-inner').innerHTML = html;
        }

        function renderTabs() {
            const container = document.getElementById('day-tabs');
            container.innerHTML = '';
            
            // Date Tabs
            itineraryData.forEach((day, idx) => {
                const btn = document.createElement('button');
                btn.className = `flex-1 py-4 relative group focus:outline-none transition-all duration-500`;
                btn.onclick = () => switchDay(idx);
                
                const isActive = idx === currentActiveDay;
                const colorClass = isActive ? 'text-stone-800 opacity-100' : 'text-stone-400 opacity-60 hover:opacity-100';
                const scaleClass = isActive ? 'scale-110' : 'scale-100';

                btn.innerHTML = `
                    <div class="flex flex-col items-center ${colorClass} ${scaleClass} transition-all duration-500">
                        <span class="text-[10px] font-bold tracking-widest font-sans-en mb-1">DEC</span>
                        <span class="text-xl font-serif-en italic">${day.shortDate}</span>
                    </div>
                    <div class="absolute bottom-2 left-1/2 transform -translate-x-1/2 w-1 h-1 rounded-full bg-stone-800 transition-all duration-500 ${isActive ? 'opacity-100 scale-100' : 'opacity-0 scale-0'}"></div>
                `;
                container.appendChild(btn);
            });
            
            // Wallet Tab
            const walletBtn = document.createElement('button');
            walletBtn.id = 'tab-wallet';
            walletBtn.className = `flex-1 py-4 relative group focus:outline-none transition-all duration-500`;
            walletBtn.onclick = () => switchToWallet();
            
            const isWalletActive = currentActiveDay === 'wallet';
            const wColorClass = isWalletActive ? 'text-stone-800 opacity-100' : 'text-stone-400 opacity-60 hover:opacity-100';
            const wScaleClass = isWalletActive ? 'scale-110' : 'scale-100';

            walletBtn.innerHTML = `
                <div class="flex flex-col items-center ${wColorClass} ${wScaleClass} transition-all duration-500">
                    <span class="text-[10px] font-bold tracking-widest font-sans-en mb-1">EXP</span>
                    <span class="text-xl font-serif-en">Â¥</span>
                </div>
                <div class="absolute bottom-2 left-1/2 transform -translate-x-1/2 w-1 h-1 rounded-full bg-stone-800 transition-all duration-500 ${isWalletActive ? 'opacity-100 scale-100' : 'opacity-0 scale-0'}"></div>
            `;
            container.appendChild(walletBtn);
        }

        function toggleEventDetails(element) {
            const item = element.closest('.itinerary-item');
            item.classList.toggle('active');
        }

        function animateIcon(element, icon) {
            const span = element.querySelector('span');
            if (icon.includes('âœˆï¸') || icon.includes('ğŸ›¬') || icon.includes('ğŸ›«')) {
                if (span.classList.contains('animate-plane')) return;
                span.classList.add('animate-plane');
                setTimeout(() => {
                    span.classList.remove('animate-plane');
                }, 1200); 
            } else {
                span.classList.add('animate-bounce-custom');
                setTimeout(() => {
                    span.classList.remove('animate-bounce-custom');
                }, 500);
            }
        }

        function getWeatherSvg(condition) {
            const c = condition ? condition.toLowerCase() : '';
            if(c.includes('sunny') || c.includes('clear')) return `<svg class="w-24 h-24 text-yellow-600 drop-shadow-md" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>`;
            if(c.includes('cloud')) return `<svg class="w-24 h-24 text-stone-500 drop-shadow-md" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"></path></svg>`;
            if(c.includes('rain')) return `<svg class="w-24 h-24 text-blue-500 drop-shadow-md" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>`;
            return `<svg class="w-24 h-24 text-stone-400 drop-shadow-md" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>`;
        }

        // --- Wallet Views ---
        function switchToWallet() {
            currentActiveDay = 'wallet';
            renderTabs();
            
            if (isBookingOpen) toggleBookingDetails();
            
            document.getElementById('next-event-bar').classList.add('force-hidden');
            
            const container = document.getElementById('itinerary-content');
            window.scrollTo({ top: 0, behavior: 'smooth' });

            container.innerHTML = `
                <div class="px-8 pt-10 pb-6 animate-fade-in">
                    <h2 class="text-3xl font-bold font-serif-jp text-stone-800 mb-2">æ¶ˆè²»è¨˜å¸³</h2>
                    <p class="text-xs text-stone-500 font-sans-en tracking-widest uppercase mb-6">Expense Tracker</p>
                    
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-3 gap-2 mb-8">
                        <div class="bg-stone-800 text-white p-3 rounded-xl flex flex-col items-center justify-center shadow-md">
                             <span class="text-[10px] font-sans-en uppercase tracking-wider opacity-70">TOTAL</span>
                             <span id="wallet-total" class="text-lg font-bold font-serif-en mt-1">Â¥0</span>
                        </div>
                        <div class="bg-white border border-stone-200 p-3 rounded-xl flex flex-col items-center justify-center shadow-sm">
                             <span class="text-[10px] font-sans-jp font-bold text-stone-400">ğŸ• é£Ÿå±ç‹—</span>
                             <span id="wallet-dog" class="text-sm font-bold font-serif-en text-stone-700 mt-1">Â¥0</span>
                        </div>
                        <div class="bg-white border border-stone-200 p-3 rounded-xl flex flex-col items-center justify-center shadow-sm">
                             <span class="text-[10px] font-sans-jp font-bold text-stone-400">ğŸ· éšè±¬ç‹</span>
                             <span id="wallet-pig" class="text-sm font-bold font-serif-en text-stone-700 mt-1">Â¥0</span>
                        </div>
                    </div>
                    
                    <!-- Input Form -->
                    <div class="mb-8">
                        <button onclick="document.getElementById('wallet-form-container').classList.toggle('open')" class="flex items-center justify-between w-full text-left text-xs font-bold text-stone-500 uppercase tracking-widest mb-4 hover:text-stone-800 transition-colors">
                            <span>+ Add New Record</span>
                            <span class="text-lg">+</span>
                        </button>
                        
                        <div id="wallet-form-container" class="bg-white p-6 rounded-xl shadow-sm border border-stone-100 open">
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div class="col-span-2">
                                    <label class="text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-1 block">Item</label>
                                    <input type="text" id="expense-item" class="input-premium w-full" placeholder="e.g. Dinner, Taxi">
                                </div>
                                <div>
                                    <label class="text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-1 block">Amount (Â¥)</label>
                                    <input type="number" id="expense-amount" class="input-premium w-full" placeholder="0">
                                </div>
                                <div>
                                    <label class="text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-1 block">Category</label>
                                    <select id="expense-category" class="input-premium w-full">
                                        <option value="food">Food</option>
                                        <option value="transport">Transport</option>
                                        <option value="shopping">Shopping</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div class="col-span-2">
                                    <label class="text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-1 block">Who Paid?</label>
                                    <div class="flex gap-3">
                                        <label class="flex-1 cursor-pointer group">
                                            <input type="radio" name="expense-person" value="é£Ÿå±ç‹—" class="peer hidden" checked>
                                            <div class="input-premium text-center text-stone-500 peer-checked:bg-stone-800 peer-checked:text-white peer-checked:border-stone-800 transition-all group-hover:bg-stone-100">
                                                ğŸ• é£Ÿå±ç‹—
                                            </div>
                                        </label>
                                        <label class="flex-1 cursor-pointer group">
                                            <input type="radio" name="expense-person" value="éšè±¬ç‹" class="peer hidden">
                                            <div class="input-premium text-center text-stone-500 peer-checked:bg-stone-800 peer-checked:text-white peer-checked:border-stone-800 transition-all group-hover:bg-stone-100">
                                                ğŸ· éšè±¬ç‹
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <button onclick="submitExpense()" class="w-full bg-stone-800 text-white py-3 rounded-lg font-sans-en font-bold uppercase tracking-widest text-xs hover:bg-stone-700 transition-colors shadow-lg shadow-stone-200">
                                Add Record
                            </button>
                        </div>
                    </div>
                    
                    <!-- List Header -->
                     <h3 class="text-lg font-bold font-serif-jp text-stone-700 mb-4 pb-2 border-b border-stone-200">æ¶ˆè²»æ˜ç´°</h3>

                    <!-- List -->
                    <div id="wallet-list" class="space-y-3 animate-zoom-in">
                        <!-- List items injected here -->
                    </div>
                </div>
            `;
            renderWalletList();
        }

        function submitExpense() {
            const item = document.getElementById('expense-item').value;
            const amount = document.getElementById('expense-amount').value;
            const category = document.getElementById('expense-category').value;
            const person = document.querySelector('input[name="expense-person"]:checked').value;
            
            if(!item || !amount) return;
            
            addExpense(item, amount, category, person);
            
            document.getElementById('expense-item').value = '';
            document.getElementById('expense-amount').value = '';
        }

        function renderWalletList() {
            const list = document.getElementById('wallet-list');
            if(!list) return;
            
            const data = getWalletData().sort((a, b) => b.id - a.id);
            
            if (data.length === 0) {
                list.innerHTML = `<p class="text-center text-stone-400 text-sm py-10 italic font-serif-en">No records yet.</p>`;
                updateBudget();
                return;
            }

            let html = '';
            data.forEach(record => {
                const iconMap = { food: 'ğŸ”', transport: 'ğŸš‡', shopping: 'ğŸ›ï¸', other: 'âœ¨' };
                const personBadge = record.person === 'é£Ÿå±ç‹—' ? 'ğŸ• é£Ÿå±ç‹—' : 'ğŸ· éšè±¬ç‹';
                
                html += `
                    <div class="bg-white p-4 rounded-xl border border-stone-100 flex justify-between items-center shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full bg-stone-50 flex items-center justify-center text-xl mr-3 border border-stone-100">
                                ${iconMap[record.category]}
                            </div>
                            <div>
                                <p class="font-bold text-stone-800 text-sm font-sans-jp">${record.item}</p>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-[9px] bg-stone-100 px-2 py-0.5 rounded-full text-stone-600 font-sans-jp font-bold">${personBadge}</span>
                                    <span class="text-[9px] text-stone-400 font-sans-en">${record.date}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col items-end">
                            <div class="flex items-center">
                                <span class="font-serif-en font-bold text-stone-800 mr-3 text-lg">Â¥${record.amount.toLocaleString()}</span>
                                <!-- ä½¿ç”¨ event.stopPropagation() é˜²æ­¢é»æ“Šå¡ç‰‡å…¶ä»–åœ°æ–¹ -->
                                <button type="button" onclick="window.removeWalletItem(${record.id}); event.stopPropagation();" class="w-10 h-10 rounded-full flex items-center justify-center text-stone-400 hover:text-red-600 hover:bg-red-50 transition-colors relative z-50 p-2 shadow-sm border border-transparent hover:border-red-100" aria-label="åˆªé™¤">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="pointer-events: none;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            list.innerHTML = html;
            updateBudget(); 
        }

        function switchDay(idx) {
            currentActiveDay = idx;
            renderTabs();
            const day = itineraryData[idx];
            const hiddenEvents = JSON.parse(localStorage.getItem('japanTripHiddenEvents')) || {};
            
            fetchRealTimeWeather(idx);

            if (isBookingOpen) {
                toggleBookingDetails();
            }
            
            document.getElementById('next-event-bar').classList.remove('force-hidden');
            
            const container = document.getElementById('itinerary-content');

            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // Update Next Event Bar Info
            const nextEventBar = document.getElementById('next-event-bar');
            const nextTitle = document.getElementById('next-event-title');
            const nextTime = document.getElementById('next-event-time');
            const nextIcon = document.getElementById('next-event-icon');

            // Find first visible event
            let firstEvent = null;
            for (let i = 0; i < day.events.length; i++) {
                if (!hiddenEvents[`${idx}-${i}`]) {
                    firstEvent = day.events[i];
                    break;
                }
            }

            if (firstEvent) {
                nextTitle.innerText = firstEvent.activity;
                nextTime.innerText = firstEvent.time.split(' ')[0];
                nextIcon.innerText = firstEvent.icon;
                nextEventBar.classList.remove('force-hidden');
                nextEventBar.classList.remove('scroll-hidden'); 
            } else {
                nextEventBar.classList.add('force-hidden');
            }

            // Header - CENTERED WEATHER ONLY (Title REMOVED)
            let html = `
                <div class="px-8 pt-10 pb-6 animate-fade-in reveal-item">
                    <div class="flex flex-col items-center justify-center border-b border-stone-300 pb-8 mb-8">
                        <!-- Weather Icon -->
                        <div id="weather-icon-display" class="mb-4 transition-transform transform hover:scale-110">
                            ${getWeatherSvg(day.weather.condition)}
                        </div>
                        <!-- Temp -->
                        <div class="text-center">
                            <p id="weather-temp-display" class="text-7xl font-serif-en text-stone-800 leading-none">${day.weather.temp}</p>
                            <p id="weather-condition-display" class="text-[10px] font-sans-en text-stone-400 uppercase tracking-widest mt-2">${day.weather.condition}</p>
                        </div>
                    </div>
                    
                    <div class="mb-10">
                         <p class="font-serif-jp font-bold text-stone-600 leading-loose text-sm border-l-2 border-stone-300 pl-4">
                            ${day.guide}
                         </p>
                    </div>
                </div>
            `;

            html += `<div class="px-4 space-y-0 animate-zoom-in">`; 
            
            day.events.forEach((ev, i) => {
                const delay = i * 150;
                
                // Check if hidden
                if (hiddenEvents[`${idx}-${i}`]) return;

                html += `
                    <div class="itinerary-item reveal-item group cursor-pointer py-5 px-4 rounded-lg" style="transition-delay: ${delay}ms" onclick="toggleEventDetails(this)">
                        <div class="timeline-line"></div>

                        <div class="flex items-start relative z-10">
                            <div class="w-16 pt-1 text-right mr-6 flex-shrink-0">
                                <p class="font-serif-en text-lg text-stone-800">${ev.time}</p>
                            </div>

                            <div class="w-8 h-8 rounded-full bg-[#EFE9E1] border border-stone-300 flex items-center justify-center text-sm mr-4 z-20 shadow-sm group-hover:scale-110 transition-transform" onclick="animateIcon(this, '${ev.icon}'); event.stopPropagation();">
                                <span class="inline-block transition-all">${ev.icon}</span>
                            </div>

                            <div class="flex-1 pt-0.5 border-b border-stone-300/40 pb-5 group-last:border-0 relative">
                                <!-- NEW: HIDE BUTTON INSIDE DETAILS TO AVOID ACCIDENTAL CLICKS -->
                                <div class="flex justify-between items-center">
                                    <h3 class="text-base font-bold font-serif-jp text-stone-800 group-hover:text-stone-600 transition-colors ${ev.isWarning ? 'text-red-700' : ''}">${ev.activity}</h3>
                                    <div class="chevron text-stone-300 transition-transform duration-500">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </div>
                                </div>
                                
                                <div class="item-details">
                                    <div class="pt-4 space-y-3">
                                        <p class="text-sm text-stone-500 font-sans-jp leading-relaxed">${ev.desc}</p>
                                        
                                        ${ev.address ? `
                                        <div class="flex items-center justify-between mt-2">
                                            <p class="text-[10px] text-stone-400 font-sans-en uppercase tracking-wide truncate w-2/3">${ev.address}</p>
                                            <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(ev.address)}" target="_blank" onclick="event.stopPropagation()" class="text-[10px] font-bold font-sans-en text-stone-800 border-b border-stone-800 hover:text-stone-500 hover:border-stone-500 transition-colors pb-0.5">
                                                NAVIGATE
                                            </a>
                                        </div>` : ''}
                                        
                                        <div class="flex justify-between items-end mt-3 border-t border-stone-200 pt-2">
                                            <button onclick="event.stopPropagation(); window.hideItineraryItem(${idx}, ${i})" class="text-xs text-red-400 hover:text-red-600 font-sans-jp flex items-center">
                                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path></svg>
                                                éš±è—æ­¤è¡Œç¨‹ (ä¸è¨ˆå…¥é ç®—)
                                            </button>
                                            ${ev.cost > 0 ? `
                                            <p class="text-right text-xs font-serif-en text-stone-400">Â¥${ev.cost.toLocaleString()}</p>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += `</div>`;
            html += `<div class="h-28"></div>`; 

            container.innerHTML = html;

            setTimeout(() => {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('visible');
                            observer.unobserve(entry.target);
                        }
                    });
                }, { root: null, threshold: 0.05, rootMargin: "0px 0px 50px 0px" });

                const elements = container.querySelectorAll('.reveal-item');
                elements.forEach((el) => observer.observe(el));
            }, 50);
        }

        function switchToEmergency() {
            currentActiveDay = -1;
            renderTabs(); 
            
            if (isBookingOpen) toggleBookingDetails();
            
            document.getElementById('next-event-bar').classList.add('force-hidden');

            const container = document.getElementById('itinerary-content');
            let html = `
                <div class="px-8 pt-8 pb-6 animate-zoom-in reveal-item visible">
                    <h2 class="text-3xl font-serif-jp font-bold text-red-800 mb-2">ç·Šæ€¥è¯çµ¡</h2>
                    <p class="text-xs text-red-400 font-sans-en tracking-widest uppercase">Emergency Assistance</p>
                </div>
                <div class="px-4 space-y-3 animate-zoom-in">
            `;

            EMERGENCY_INFO.forEach((info, index) => {
                const delay = index * 100;
                html += `
                    <div class="bg-[#E8E2D9] p-6 rounded-sm flex items-center justify-between reveal-item visible" style="transition-delay: ${delay}ms">
                        <div>
                            <p class="text-xs font-sans-en font-bold text-stone-400 uppercase tracking-widest mb-1">${info.title}</p>
                            <p class="text-2xl font-serif-en text-stone-800">${info.number}</p>
                            <p class="text-xs text-stone-500 font-sans-jp mt-1">${info.desc}</p>
                        </div>
                        <a href="tel:${info.number.replace(/\s/g, '')}" class="w-10 h-10 rounded-full border border-stone-300 flex items-center justify-center text-stone-400 hover:bg-stone-800 hover:text-white transition-all">
                            <span class="text-lg">ğŸ“</span>
                        </a>
                    </div>
                `;
            });
            html += `</div>`;
            container.innerHTML = html;
        }

        // Scroll Event Logic - SMART SCROLL
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('itinerary-content');
            const nextEventBar = document.getElementById('next-event-bar');
            
            container.addEventListener('scroll', () => {
                const scrollTop = container.scrollTop;
                
                // Threshold of 10px to avoid jitter
                if (Math.abs(scrollTop - lastScrollTop) > 10) {
                    if (scrollTop > lastScrollTop && scrollTop > 50) {
                        // Scroll Down -> Hide
                        nextEventBar.classList.add('scroll-hidden');
                    } else {
                        // Scroll Up -> Show
                        nextEventBar.classList.remove('scroll-hidden');
                    }
                }
                lastScrollTop = scrollTop <= 0 ? 0 : scrollTop; 
            });
        });

        window.onload = function() {
            renderBookingInfo();
            renderTabs();
            // Initialize with first day
            switchDay(0);
            updateBudget();
            // Ensure booking details is closed initially
            isBookingOpen = false;
            document.getElementById('booking-details-content').classList.remove('open');
        };
    </script>
</body>
</html>
